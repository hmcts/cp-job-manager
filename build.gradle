plugins {
    id 'maven-publish'
    id 'com.avast.gradle.docker-compose' version '0.17.20'
}

def githubActor = project.findProperty("github.actor") ?: System.getenv("GITHUB_ACTOR")
def githubToken = project.findProperty("github.token") ?: System.getenv("GITHUB_TOKEN")
def githubRepo = System.getenv("GITHUB_REPOSITORY")

def azureADOArtifactRepository = 'https://pkgs.dev.azure.com/hmcts/Artifacts/_packaging/hmcts-lib/maven/v1'
def azureADOArtifactActor = System.getenv("AZURE_DEVOPS_ARTIFACT_USERNAME")
def azureADOArtifactToken = System.getenv("AZURE_DEVOPS_ARTIFACT_TOKEN")

allprojects {
    group = "uk.gov.justice.services"
    version = "1.0.0-SNAPSHOT"

    repositories {
        mavenCentral()
        mavenLocal()
    }
    
    // Configure publishing repositories for all projects (root and subprojects)
    apply plugin: 'maven-publish'
    
    publishing {
        repositories {
            maven {
                name = "GitHubPackages"
                url = uri("https://maven.pkg.github.com/$githubRepo")
                credentials {
                    username = githubActor
                    password = githubToken
                }
            }
            maven {
                name = "AzureArtifacts"
                url = uri(azureADOArtifactRepository)
                credentials {
                    username = azureADOArtifactActor
                    password = azureADOArtifactToken
                }
            }
        }
    }
}

// Publish root project as POM-only (no source code)
publishing {
    publications {
        mavenJava(MavenPublication) {
            groupId = project.group
            artifactId = project.name
            version = project.version
            
            pom {
                name = project.name
                description = 'A stateful multithreaded job and task executor for HMCTS'
                packaging = 'pom'
            }
        }
    }
}

// Centralized dependency versions
ext.versions = [
    // Java EE APIs
    javaeeApi: '8.0.1',
    transactionApi: '1.3',
    cdiApi: '2.0',
    
    // Logging
    slf4j: '2.0.17',
    
    // Google Libraries
    guava: '33.5.0-jre',
    
    // Jackson
    jackson: '2.20.1',
    
    // JSON APIs
    jsonApi: '1.1.4',
    glassfishJson: '1.1.4',
    
    // Application Server
    tomee: '10.1.3',
    tomeeLegacy: '10.1.3',
    
    // Database
    postgresql: '42.7.8',
    
    // Testing - JUnit
    junit: '6.0.2',
    junitPlatform: '6.0.2',
    
    // Testing - Mockito
    mockito: '5.21.0',
    
    // Testing - Others
    hamcrest: '3.0',
    awaitility: '4.3.0',
    liquibase: '5.0.1',
    
    // Commons
    commonsLogging: '1.3.5'
]

subprojects {
    apply plugin: 'java-library'
    
    // Configure publications for subprojects (JAR artifacts)
    publishing {
        publications {
            // Only create publication if it doesn't already exist
            // The java-library plugin may auto-create it
            if (!publications.findByName('mavenJava')) {
                mavenJava(MavenPublication) {
                    from components.java
                }
            }
        }
    }
    
    // Apply docker-compose plugin to modules that need PostgreSQL
    if (project.name in ['jobstore-persistence', 'job-manager-it']) {
        apply plugin: 'com.avast.gradle.docker-compose'
        
        dockerCompose {
            useComposeFiles = ["${rootProject.projectDir}/docker-compose.yml"]
            captureContainersOutput = false
            stopContainers = true
            removeContainers = true
            removeVolumes = false // Keep volumes for faster subsequent runs
            waitForTcpPorts = true
            waitForTcpPortsTimeout = java.time.Duration.ofMinutes(2)
            projectName = 'cp-job-manager' // Use consistent project name
        }
        
        // Clean up before composeUp to handle stuck containers
        tasks.named('composeUp') {
            doFirst {
                // Clean up any existing containers and networks before starting
                try {
                    exec {
                        commandLine 'sh', '-c', '''
                            docker ps -aq --filter "name=cp-job-manager-postgres" | xargs -r docker rm -f 2>/dev/null || true
                            docker network rm cp-job-manager_default 2>/dev/null || true
                            docker-compose -f ${rootProject.projectDir}/docker-compose.yml -p cp-job-manager down --remove-orphans 2>/dev/null || true
                        '''
                        ignoreExitValue = true
                    }
                } catch (Exception e) {
                    // Ignore cleanup errors
                }
            }
        }
    }

    java {
        sourceCompatibility = JavaVersion.VERSION_21
        targetCompatibility = JavaVersion.VERSION_21
        toolchain {
            languageVersion = JavaLanguageVersion.of(21)
        }
    }

    // Ensure all tasks use Java 21
    tasks.withType(JavaCompile) {
        options.encoding = "UTF-8"
        options.release = 21
        options.fork = true
        options.forkOptions.javaHome = file(System.getProperty('java.home'))
    }


    tasks.withType(Test) {
        useJUnitPlatform()
        maxHeapSize = "64m"
        
        // Only include actual test classes (end with Test or Tests)
        include "**/*Test.class"
        include "**/*Tests.class"
        
        // Force tests to use Java 21
        jvmArgs = [
            "-Djava.version=21",
            "-Dfile.encoding=UTF-8"
        ]
        
        // Set system properties for Java 21 compatibility
        systemProperty "java.version", "21"
        systemProperty "file.encoding", "UTF-8"
        
        // Disable build cache for tests that depend on external services (like PostgreSQL)
        // This ensures tests always run and catch database connectivity issues
        outputs.cacheIf { false }
        
        // Configure docker-compose for tests that need PostgreSQL
        if (project.name in ['jobstore-persistence', 'job-manager-it']) {
            // Use a shared root-level composeUp task to avoid conflicts
            def sharedComposeUp = rootProject.tasks.findByName('composeUp')
            if (sharedComposeUp == null) {
                // Create root-level composeUp task if it doesn't exist
                rootProject.apply plugin: 'com.avast.gradle.docker-compose'
                rootProject.dockerCompose {
                    useComposeFiles = ["${rootProject.projectDir}/docker-compose.yml"]
                    captureContainersOutput = false
                    stopContainers = true
                    removeContainers = true
                    removeVolumes = false
                    waitForTcpPorts = true
                    waitForTcpPortsTimeout = java.time.Duration.ofMinutes(2)
                    projectName = 'cp-job-manager'
                }
                sharedComposeUp = rootProject.tasks.named('composeUp')
            }
            
            dependsOn sharedComposeUp
            finalizedBy project.tasks.named('composeDown')
            
            // Set port and host for docker-compose services
            // Port 55432 is hardcoded in docker-compose.yml
            systemProperty "POSTGRES_PORT", "55432"
            systemProperty "INTEGRATION_HOST_KEY", "localhost"
        }
        
        // Tests re-enabled with Java 21 configuration
        // enabled = false
    }

    dependencies {
        // JUnit Jupiter Engine and Platform Launcher required for tests to run
        testImplementation "org.junit.jupiter:junit-jupiter-engine:${versions.junit}"
        testImplementation "org.junit.platform:junit-platform-launcher:${versions.junitPlatform}"
        
        // Mockito version compatible with Java 21
        testImplementation "org.mockito:mockito-core:${versions.mockito}"
        testImplementation "org.mockito:mockito-junit-jupiter:${versions.mockito}"
    }
}
